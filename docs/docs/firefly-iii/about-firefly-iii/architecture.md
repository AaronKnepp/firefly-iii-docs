# Architecture

On this page you'll find the architecture of Firefly III. It's not meant as an explanation of where everything is but rather as a means to show you how everything is structured. If you ever want to develop something here's what you need to know.

!!! info
    This page is under construction. Feedback is welcome!

## Database

![Basic database structure](images/database.png)

This image shows you a graphical overview of the most important parts of the database. There are many more tables, but these are the important objects you may want to learn about. If you see something in the database you're curious about, please let me know.

### Transactions

In the picture, objects related to transactions are shown in shades of red. A "transaction group" ties multiple "transaction journals" together. Each transaction journal contains exactly two transactions. A transaction either removes or adds money from an account. A basic withdrawal or expense in Firefly III consists of: 

- One transaction group to tie everything together.
- One transaction journal to link two transactions.
- One transaction removing money from account A.
- One transaction adding money to account B.

A split transaction is one "transaction group" that contains *X* "transaction journals", one for each split. Each transaction journal contains two transactions. The amount of the witdrawal is stored in the transaction.

Accounts and transaction journals can have a currency assigned to it. Transaction journals may also have a "foreign" currency assigned to it, which is another reference to a currency object.

Transaction journals have meta data like categories, budgets and bills and tags.

Accounts are linked to transactions and to piggy banks. A transfer (see transaction type) may link a transaction journal to a piggy bank in a piggy bank event. Together they form the history of the piggy bank. A piggy bank event may exist without a link to a transaction journal.

### Rules

Rule groups contain rules. Rules have actions and triggers. Although actions and triggers may reference to budgets, categories and tags and other things, there is no database relationship. It's a type/value kind of a thing in the database.

## Code

Firefly III is based on [Laravel](https://laravel.com/), and uses the MVC model. There is a mixture of design patterns used throughout the code. Listed here are the most important parts.

### Models

Models are stored in `app/Models`. Everything in Firefly III has an associated model. Most models also have a `routeBinder` function that tells if an URL parameter is valid.

### Views

All views are stored in `resources/views/`. There is a v1 and a v2 folder. The v1 folder contains the HTML-based views you know and love. The v2 folder contains the views for the new layout, which will be a Vue app. As such those views are fairly basic (empty). Views are twig files.

### Controllers

Most pages are generated by controllers in `app/Http/Controllers`. They're grouped around objects (rules, transactions, etc) and mostly follow a CRUD-model. There are specific controllers for charts, some JSON controllers and some notable exceptions. Most of this code will have to move, in due time, to the API, because I plan to make the new layout (v2) API-only.

### API

The API code is stored in `app/Api` and consists of controllers, some basic middleware and request classes. The API code is pretty consistent: store or update objects, make some lists and transform the data into JSON. The requests can be interesting because in those requests the rules are stored that define what you can submit. The API will become the main interaction method for ALL frontend code in Firefly III, which means it will have to be greatly expanded.

### Search

There is an `OperatorQuerySearch` class stored in `app/Support/Search` that converts the search query of the user into a transaction collector (see ahead). This is basically one big database query. The query is executed and the result is shown to the user.

### Rules

Stored in the folder `app/TransactionRules/Engine` is the rule engine. It works just like the search does. It uses the rule triggers to build a search query. The transactions that are found are then handled by the actions in the `Actions` folder. The engine ties this all together.

### Events

Some events in Firefly III trigger more code. File `app/Providers/EventServiceProvider.php` shows you all events (also listed in `app/Events`) and the class + method that will trigger if the event happens. Some events trigger multiple handlers. The code of the handlers is in `app/Handlers`.

### Factory

TODO

### Generators

TODO

### Handlers

TODO

### Helpers

TODO

### Jobs

TODO

### Repositories

TODO

### Validation rules

TODO

### Services

TODO

### Support classes

### Transaction Collector

TODO

### Frontend

TODO

### Translations

TODO